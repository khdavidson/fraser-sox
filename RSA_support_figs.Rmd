---
title: "RSA Support Info"
author: "FIA Sockeye Stock Assessment"
date: "Last update: `r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE, message=F, warning=F, echo=F}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(cowplot)    # for plot_grid (superior to egg::ggarrange!)
library(readxl)

options(scipen = 9999)
set.seed(1234)

setwd("~/ANALYSIS/data")

daily.dat.raw <- read_excel("daily_counts.xlsx", sheet="all_stocks")
esc.db.raw <- read_excel("SKAll-Forecast (August 2021).xlsx", sheet="SKAll")     # << THIS WILL HAVE TO CHANGE >>
roving.dat.raw <- read_excel("Master Roving Analysis Spreadsheet.xlsx", sheet="count_data")

##########################################################################################################################

#                                                       CLEANING 

#------------ DAILY PASSAGE (SONARs & Fences) 
daily.dat <- daily.dat.raw %>% 
  mutate(date = as.Date(date, origin="1899-12-30"),
         yday = lubridate::yday(date),
         group = ifelse(year==2020, "2020", ifelse(year==2019, "2019", "Historical")),
         stock = ifelse(stock=="Horsefly River","Horsefly River*", 
                    ifelse(stock=="Mitchell River", "Mitchell River*",
                        ifelse(stock=="Stellako-Nadina", "Stellako-Nadina**", stock)))) %>% 
  print()


#------------ ESCAPEMENT DATABASE  
esc.db <- esc.db.raw %>% 
  rename(year=Year,
    watershed_group=`Watershed Group Name`,
    stock=`Stock Name(stream)`,
    timing_group=`Timing Group`,
    cu=`CU Name`,
    peak_spawn=spnpeak,
    total=Total,
    forecast_group=Forecast) %>%
  #filter(!is.na(peak_spawn), !grepl("Early", peak_spawn), !grepl("Late", peak_spawn), !grepl("Mid", peak_spawn)) %>% 
  print()

# Fixing dates - there are all sorts of entry typos, extra commas, etc. so this cleans up the dates so they are all the same formats
# Have to do this first by creating a separate dataframe to split dates and re-format each element of the date 
dt <- data.frame(str_split_fixed(esc.db$peak_spawn, "[-]|\\s", 4)) 
names(dt) <- c("st_month","st_day","end_t1","end_t2")
dt$yr <- esc.db$year

dt1 <- data.frame(sapply(dt, function(x)gsub("[.]", "", x)))          # removing dot(.) and replacing with ""
dt1$start_date <- as.Date(paste0(dt1$st_day, dt1$st_month, dt1$yr), format="%d%b%Y")
dt1$end_date <- ifelse(dt1$end_t2=="", paste0(dt1$end_t1, dt1$st_month), paste0(dt1$end_t2, dt1$end_t1))
dt1$end_date <- as.Date(paste0(dt1$end_date, dt1$yr), format="%d%b%Y")

dates <- dt1 %>% 
  select(start_date, end_date) %>% 
  print() 

# Check before joining - these values need to match 
nrow(dates)
nrow(esc.db)

#-- Join 
esc.db <- cbind(esc.db, dates)

#-- Clean joined frame 
esc.db <- esc.db %>% 
  mutate(start_yday = lubridate::yday(start_date),
         end_yday = lubridate::yday(end_date),
         forecast_group = case_when(forecast_group==1~"Early Stuart",forecast_group==2~"Late Stuart",
                                    forecast_group==3~"Stellako", forecast_group==4~"Bowron", forecast_group==5~"Raft",
                                    forecast_group==6~"Quesnel", forecast_group==7~"Chilko", forecast_group==8~"Seymour",
                                    forecast_group==9~"Late Shuswap", forecast_group==10~"Birkenhead",
                                    forecast_group==11~"Cultus", forecast_group==12~"Portage", 
                                    forecast_group==13~"Weaver Creek", forecast_group==14~"Fennel Creek",
                                    forecast_group==15~"Scotch Creek", forecast_group==16~"Gates",
                                    forecast_group==17~"Nadina", forecast_group==18~"Upper Pitt River",
                                    forecast_group==19~"Harrison", forecast_group==20~"Fraser Pink",
                                    forecast_group==21~"South Thompson", forecast_group==22~"Taseko",
                                    forecast_group==23~"Chilliwack", forecast_group==24~"Nahatlatch",
                                    forecast_group==25~"North Thompson", forecast_group==26~"North Thompson Misc",
                                    forecast_group==27~"Widgeon", forecast_group==28~"Harrison (D/S)") ,
         group = ifelse(year==lubridate::year(Sys.Date()), lubridate::year(Sys.Date()), 
                   ifelse(year==2020, 2020,    # these years kept static for  big bar reference years
                     ifelse(year==2019, 2019,  # these years kept static for  big bar reference years
                       ifelse(is.na(year), "Historical", "Historical")))) ,
         timing_group = case_when(timing_group=="T1"~"", timing_group=="T2"~"Early Summer", 
                                  timing_group=="T3"~"Summer", timing_group=="T4"~"Late") ,
         era = ifelse(year<2000, "Pre-2000", "2000-present")) %>%
  rename(POS_start = start_date,
         POS_end = end_date) %>%
  print()



#------------ ROVING DATA 
roving.dat <- roving.dat.raw %>% 
  rename(year=Year,
    timing_group=`Run Timing`,
    watershed_group=`Watershed Group`,
    system=`Stream/Shore`,
    survey=`Survey #`,
    date=Date,
    survey_type=`Survey Type`,
    area=Area,
    area_descr=`Area Description`,
    live_obs1=`Live Count 1`,
    live_obs2=`Live Count 2`,
    oe=`Obs. Eff.`,
    hold_perc=`%Hold`,
    spawn_perc=`%Spawning`,
    spawnout_perc=`%SpawnedOut`,
    carc_male=`Carcass Male`,
    carc_fem=`Carcass Female`,
    male_nr=`Male Carcass NR`,
    fem_nr=`Female Carcass NR`,
    fem_0=`Female Carcass 0%`,
    fem_50=`Female Carcass 50%`,
    fem_100=`Female Carcass 100%`,
    carc_jack=`Carcass Jack`,
    carc_unsex_ground=`Ground Carcass Unsexed`,
    carc_unsex_aerial1=`Aerial Carcass Unsexed Observer 1`,
    carc_unsex_aerial2=`Aerial Carcass Unsexed Observer 2`,
    carc_unsex=`Carcass Unsexed (interpret "blank" as zero carcasses)`) %>% 
  mutate(date=as.Date(date)) %>% 
  print()
```

<br>

<br>

StADSOX data are used here to provide summary information to guide the RSA process among other things. This is not to be interpreted as a formal analysis and **should not be distributed widely**. Some caveats:

* There are no SEP channel data included, unless already accounted for in the Sockeye Escapement Database
* Stellako data are questionable because a) changing program start dates may/may not capture Nadina, and b) uncertainty over the daily % Stellako/Nadina each year (DNA is not always taken each year so the opportunity to split daily passage by stock composition is not always known)
* Daily passage data are not intended to be used to generate escapement abundances. Much post-processing analysis is done to allocate sockeye to lake spawning, tributaries, channels, etc. These data should never be summed to estimate total escapement.
* Daily passage code needs to be updated each year depending on the focal year of interest and which systems have useable programs (e.g., Quesnel only gets a sonar in its dominant year(s)).
* Forecast groups should be double-checked; Taseko in particular might not be represented by forecast grouping value for all yrs (might just be a subset of years)
* Peak of spawn data: variable data quality exists based on effort (survey frequency and duration) so these should be taken with a grain of salt
* No controls for effort etc. made (e.g., survey cycle, program length, etc.)

<br>

<br>

## Arrival timing ##

-------

The following information presents dates at which 10% of the total run passed the sonar or fence. 

```{r, echo=F, include=F}
# Extract 10% passage dates for all systems and years in the spreadsheet
# (Exclude Stellako as it isn't appropriate for this type of analysis)
dates_10p <- daily.dat %>% 
  group_by(stock, year) %>% 
  mutate(cuml_daily_abundance = cumsum(daily_abundance), 
         cuml_daily_perc = (cuml_daily_abundance/sum(daily_abundance))*100) %>% 
  filter(cuml_daily_perc >= 10.0) %>%
  group_by(stock, year) %>%      
  filter(date == min(date)) %>%
  mutate(p10_flag = "10% date",
         yday = lubridate::yday(date),
         stock = ifelse(stock=="Horsefly River","Horsefly River*", 
                    ifelse(stock=="Mitchell River", "Mitchell River*",
                        ifelse(stock=="Stellako-Nadina", "Stellako-Nadina**", stock)))) %>%
  select(stock, year, date, yday, group, p10_flag) %>%
  print()

# Join 10% date flags with full dataset for plotting
forplot <- left_join(daily.dat, dates_10p) %>%
  print()
```

```{r, echo=F, message=F, warning=F}
dates_10p$stock <- factor(dates_10p$stock, levels=c("Upper Chilliwack", "Cultus", "Scotch Creek", "Birkenhead", 
  "Horsefly River*", "Mitchell River*", "Quesnel",  "Chilko", "Stellako-Nadina**", "Nadina"), ordered=T)

# FIGURE: 10% arrival dates.
ggplot(dates_10p, aes(y=stock, x=as.Date(yday, origin = as.Date("1970-01-01")))) +
  geom_hline(yintercept = 4.5, colour="red", linetype="dashed", inherit.aes=F) +
  geom_jitter(aes(fill=group, size=group, colour=group), stat="identity", width=0.4, height=0, stroke=1.5, shape=21) +
  scale_fill_manual(name=NULL, breaks=c("2020", "2019", "Historical"), values=c("#00b8ff", "gray60", "gray80")) +
  scale_colour_manual(name=NULL, breaks=c("2020", "2019", "Historical"), values=c("black", "gray20", "gray70")) +
  scale_size_manual(name=NULL, breaks=c("2020", "2019", "Historical"), values=c(4.5, 3.5, 3.5)) +
  scale_y_discrete(drop=F) +
  scale_x_date(date_labels = "%b %d", date_breaks="4 day") +
  #geom_text(aes(label=data_quality), size=4, nudge_x=0.22, nudge_y=2, angle=15, check_overlap=T, colour="red") +   
  labs(x="", y="") +
  theme_bw() +
  theme(axis.text=element_text(colour="black", size=13),
    axis.text.x = element_text(angle=30, hjust=1),
    plot.caption = element_text(size=10, hjust=0, face="italic"),
    panel.grid = element_line(colour="gray80"),
    legend.position = c(0.15,0.6),
    legend.background = element_rect(colour="black", fill=alpha("white", 0.7)),
    legend.key = element_blank(),
    legend.margin=margin(t=-0.1, r=0.15, b=0.1, l=0.1, unit="cm")) 
```

<font size="1">*Fig 1. Arrival dates at which >=10% of the total sockeye escapement passed the fence or SONAR up to and including `r lubridate::year(Sys.Date())-1`. &ast;Horsefly River had SONARs in 2006, 2007 and 2010 all with the same 10% date; Mitchell River had a SONAR in 2009. &ast;&ast;Stellako-Nadina is an aggregate of both Stellako and Nadina sockeye. Program start dates varied over time. Points are jittered to show multiple years with the same 10% arrival date. Program names are organized from north to south; red line indicates stocks above and below the Big Bar landslide.*</font>

<br> 

```{r, echo=F, message=F, warning=F, include=F}
# FIGURE: Single stock - manually change the << stock=="" >> argument
ggplot(data=forplot) +
  geom_line(data=subset(forplot %>% filter(stock=="Cultus")), 
    aes(x=as.Date(yday, origin = as.Date("1970-01-01")), y=daily_abundance, group=year, colour=group, alpha=group), size=1) +
  geom_point(data=subset(forplot %>% filter(stock=="Cultus", p10_flag=="10% date")), 
    aes(x=as.Date(yday, origin = as.Date("1970-01-01")), y=daily_abundance, group=year, colour=group, fill=group, size=group, alpha=group), 
    stroke=1.5, shape=21) +
  scale_colour_manual(name="Cultus", breaks=c("2020", "2019", "Historical"), values=c("#00b8ff", "gray40", "gray60")) +
  scale_fill_manual(name="Cultus", breaks=c("2020", "2019", "Historical"), values=c("#00b8ff", "gray40", "gray60")) +
  scale_alpha_manual(name="Cultus", breaks=c("2020", "2019", "Historical"), values=c(0.9, 0.9, 0.5)) +
  scale_size_manual(name="Cultus", breaks=c("2020", "2019", "Historical"), values=c(6.5, 5, 4.5)) +
  scale_x_date(date_labels = "%b %d", date_breaks="7 day") +
  scale_y_continuous(breaks=seq(0,1300,by=400)) +
  labs(x="", y="Daily abundance") +
  theme_bw() +
  theme(text = element_text(colour="black", size=27),
    panel.grid = element_line(colour="gray85"),
    axis.title.y = element_text(face="bold"),
    axis.text = element_text(colour="black"),
    axis.text.x = element_text(angle=30, hjust=1),
    legend.position = c(0.16,0.85),
    legend.background = element_rect(colour="black"),
    legend.margin=margin(t=0, r=0.15, b=0.1, l=0.1, unit="cm"),
    legend.spacing.y = unit(0.2, "cm"),
    legend.title = element_text(face="bold")) 
```

```{r, echo=F, message=F, warning=F, out.width="100%", out.height="75%"}
forplot$group <- factor(forplot$group, levels=c("Historical", "2019", "2020"), ordered=T)
forplot$stock <- factor(forplot$stock, levels=c("Upper Chilliwack", "Cultus", "Scotch Creek", "Birkenhead", 
  "Horsefly River*", "Mitchell River*", "Quesnel",  "Chilko", "Stellako-Nadina**", "Nadina"), ordered=T)

# FIGURE - 10% dates superimposed on run curves for all stocks
ggplot() +
  geom_line(data=forplot, 
    aes(x=as.Date(yday, origin=as.Date("1970-01-01")), y=daily_abundance, 
        group=year, colour=group, alpha=group), size=0.8) +
  geom_point(data=subset(forplot %>% filter(p10_flag=="10% date")), 
    aes(x=as.Date(yday, origin=as.Date("1970-01-01")), y=daily_abundance, 
        group=year, colour=group, fill=group, size=group, alpha=group), 
    stroke=1.2, shape=21) +
  scale_colour_manual(name=NULL, breaks=c("2020", "2019", "Historical"), values=c("#00b8ff", "gray40", "gray60")) +
  scale_fill_manual(name=NULL, breaks=c("2020", "2019", "Historical"), values=c("#00b8ff", "gray40", "gray60")) +
  scale_alpha_manual(name=NULL, breaks=c("2020", "2019", "Historical"), values=c(0.9, 0.9, 0.5)) +
  scale_size_manual(name=NULL, breaks=c("2020", "2019", "Historical"), values=c(2, 2, 1)) +
  scale_x_date(date_labels = "%b %d", date_breaks="20 day") +
  labs(x="", y="Daily abundance") +
  theme_bw() +
  theme(text = element_text(colour="black", size=13),
    panel.grid = element_blank(),
    plot.caption = element_text(size=10, hjust=0, face="italic"),
    axis.title.y = element_text(face="bold"),
    axis.text = element_text(colour="black"),
    axis.text.x = element_text(angle=30, hjust=1),
    legend.position = c(0.85,0.1),
    legend.background = element_rect(colour="black"),
    legend.margin=margin(t=0, r=0.15, b=0.1, l=0.1, unit="cm"),
    legend.spacing.y = unit(0.2, "cm")) +
  facet_wrap(~stock, scales="free")
```

<font size="1">*Fig 2. Migration curves with 10% arrival dates (points) up to `r lubridate::year(Sys.Date())-1`. &ast;Horsefly River had SONARs in 2006, 2007 and 2010 all with the same 10% date. Mitchell River had a SONAR in 2009. &ast;&ast;Stellako-Nadina is an aggregate of both Stellako and Nadina sockeye; program start dates varied over time.*</font>

<br>

<br>

## Peak of spawn ##

-------

```{r, echo=F, message=F, warning=F}
esc.db$timing_group <- factor(esc.db$timing_group, levels=c("", "Early Summer", "Summer", "Late"), ordered=T)

ggplot(data=esc.db%>%filter(!is.na(forecast_group), !is.na(peak_spawn), !grepl("Early", peak_spawn), 
                            !grepl("Late", peak_spawn), !grepl("Mid", peak_spawn)),
       aes(x=as.Date(start_yday, origin = as.Date("1970-01-01")), xend=as.Date(end_yday, origin = as.Date("1970-01-01")),
           y=reorder(forecast_group, desc(forecast_group)), 
           yend=reorder(forecast_group, desc(forecast_group)), colour=group, alpha=group, size=group)) +
  geom_segment(stat="identity") +
  scale_colour_manual(name="Peak of spawn", breaks=c("2020", "2019", "Historical"), 
                      values=c("purple", "#00b8ff", "gray60")) +
  scale_alpha_manual(name="Peak of spawn", breaks=c("2020", "2019", "Historical"), values=c(0.7, 0.6, 0.35)) +
  scale_size_manual(name="Peak of spawn", breaks=c("2020", "2019", "Historical"), values=c(3, 2, 1.5)) +
  scale_x_date(date_labels = "%b %d", date_breaks="10 day") +
  labs(x="", y="") +
  facet_wrap(~timing_group, strip.position = "left", scales = "free_y",  nrow=4) +
  theme_bw() +
  theme(panel.grid.major.x = element_line(colour="gray85"),
    panel.grid.minor.x = element_blank(),
    panel.grid.major.y = element_line(colour="gray85"),
    panel.spacing = unit(0, "lines"),
    plot.caption = element_text(size=10, hjust=0, face="italic"),
    axis.title.y = element_text(face="bold"),
    axis.text.y = element_text(colour="black", size=8),
    axis.text.x = element_text(colour="black", angle=30, hjust=1, size=10),
    legend.position = c(0.86, 0.81),
    legend.background = element_rect(colour="black"),
    legend.margin=margin(t=0.1, r=0.25, b=0.1, l=0.1, unit="cm"),
    legend.spacing.y = unit(0.2, "cm"),
    legend.title = element_text(face="bold", size=10),
    legend.text = element_text(size=9),
    strip.placement = "outside",                     
    strip.background = element_rect(fill = "white", colour="white"),
    strip.text.y = element_text(angle=90, colour="black", face="bold", size=11)) 
```

<font size="1">*Figure 3a. Peak of spawn ranges for forecast group stocks from 2000-`r lubridate::year(Sys.Date())-1` (`r lubridate::year(Sys.Date())` not yet included in the DFO escapement database). Years <2000 were omitted due to data quality concerns, but it should be noted that 2000 is an arbitrary break point.*</font>

<br>

<br>

```{r, echo=F, message=F, warning=F}
ggplot(data=esc.db%>%filter(is.na(forecast_group), !is.na(peak_spawn), !grepl("Early", peak_spawn), 
                            !grepl("Late", peak_spawn), !grepl("Mid", peak_spawn)),
       aes(x=as.Date(start_yday, origin = as.Date("1970-01-01")), xend=as.Date(end_yday, origin = as.Date("1970-01-01")),
           y=reorder(stock, desc(stock)), 
           yend=reorder(stock, desc(stock)), colour=group, alpha=group, size=group)) +
  geom_segment(stat="identity") +
  scale_colour_manual(name="Peak of spawn", breaks=c("2020", "2019", "Historical"), 
                      values=c("purple", "#00b8ff", "gray60")) +
  scale_alpha_manual(name="Peak of spawn", breaks=c("2020", "2019", "Historical"), values=c(0.7, 0.6, 0.35)) +
  scale_size_manual(name="Peak of spawn", breaks=c("2020", "2019", "Historical"), values=c(3, 2, 1.5)) +
  scale_x_date(date_labels = "%b %d", date_breaks="10 day") +
  labs(x="", y="") +
  facet_wrap(~timing_group, strip.position = "left", scales = "free_y",  nrow=4) +
  theme_bw() +
  theme(panel.grid.major.x = element_line(colour="gray85"),
    panel.grid.minor.x = element_blank(),
    panel.grid.major.y = element_line(colour="gray85"),
    panel.spacing = unit(0, "lines"),
    plot.caption = element_text(size=10, hjust=0, face="italic"),
    axis.title.y = element_text(face="bold"),
    axis.text.y = element_text(colour="black", size=8),
    axis.text.x = element_text(colour="black", angle=30, hjust=1, size=10),
    legend.position = c(0.86, 0.81),
    legend.background = element_rect(colour="black"),
    legend.margin=margin(t=0.1, r=0.25, b=0.1, l=0.1, unit="cm"),
    legend.spacing.y = unit(0.2, "cm"),
    legend.title = element_text(face="bold", size=10),
    legend.text = element_text(size=9),
    strip.placement = "outside",                     
    strip.background = element_rect(fill = "white", colour="white"),
    strip.text.y = element_text(angle=90, colour="black", face="bold", size=11)) 
```

<font size="1">*Figure 3b. Peak of spawn ranges for non-forecast group stocks from 2000-`r lubridate::year(Sys.Date())-1` (`r lubridate::year(Sys.Date())` not yet included in the DFO escapement database). Years <2000 were omitted due to data quality concerns, but it should be noted that 2000 is an arbitrary break point.*</font>

<br>

<br>

### Peak of spawn upstream of Big Bar ### 

------------

**Quesnel**

```{r include=F, echo=F}
quesnel.fcs <- esc.db %>%
  filter(forecast_group=="Quesnel", !is.na(peak_spawn) | !is.na(arrival)) %>%
  print()
```



```{r include=F, echo=F}
n_years <- esc.db %>% 
  group_by(forecast_group) %>%
  filter(!is.na(forecast_group), !is.na(peak_spawn) | !is.na(arrival)) %>%
  summarize(unique(year)) %>% 
  summarize(n=n()) %>%
  mutate(flag = ifelse(n>35, "flag", NA))

year_labs <- esc.db %>%
  filter(!is.na(forecast_group), !is.na(peak_spawn) | !is.na(arrival)) %>%
  group_by(forecast_group) %>%
  summarize(years = unique(year)) %>%
  left_join(., esc.db %>% 
              filter(!is.na(forecast_group), !is.na(peak_spawn) | !is.na(arrival)) %>%
              group_by(forecast_group) %>%
              summarize(years = unique(year)) %>%
              slice(seq(1, n(), by=2)) %>%
              mutate(label = years)) %>%
  mutate(label = ifelse(is.na(label), "", label)) %>%
  print()



pos.plot.fx <- function(FCS_GRP_NAME){
  ggplot(esc.db %>% filter(forecast_group==FCS_GRP_NAME, !is.na(peak_spawn) | !is.na(arrival)), 
         aes(x=as.Date(start_yday, origin = as.Date("1970-01-01")), xend=as.Date(end_yday, origin = as.Date("1970-01-01")), 
             y=reorder(year, desc(year)), yend=reorder(year, desc(year)), 
             colour=est_type, size=total, alpha=0.85)) +
    geom_segment(stat="identity") +
    #geom_text(aes(label=data_type), size=4, nudge_x=3.3, nudge_y=0.1, angle=0, check_overlap=T, colour="red") +
    scale_size_continuous(range=c(0.5,5)) +
    scale_colour_manual(breaks=c("Type-1: True Abundance, high resolution", 
                                 "Type-2: True Abundance, medium resolution", 
                                 "Type-3: Relative Abundance, high resolution",
                                 "Type-4: Relative Abundance, medium resolution", 
                                 "Type-5: Relative Abundance, low resolution",
                                 "Type-6: Presence or Absence"),
                        values=c("dodger blue", "green", "orange", "yellow", "red", "gray40"),
                        labels=c("T1: True abund, high res", "T2: True abund, med res", "T3: Rel. abund, high res", 
                                 "T4: Rel. abund, med res", "T5: Rel abund, med res", "T6: P/A")) +
    scale_x_date(date_labels = "%b %d", date_breaks="5 day") +
    scale_y_discrete(labels = year_labs%>%filter(forecast_group==FCS_GRP_NAME) %>% pull(label)) +
    labs(x="", y="", colour="Data quality", size="Escapement") +
    theme_bw() +
    theme(text = element_text(colour="black", size=11),
      panel.grid.major.x = element_line(colour="gray80"),
      panel.grid.minor.x = element_blank(),
      panel.grid.major.y = element_line(colour="gray80"),
      panel.spacing = unit(0, "lines"),
      axis.title.y = element_text(face="bold"),
      axis.text = element_text(colour="black", size=11),
      #axis.text.x = element_text(angle=0, hjust=1),
      legend.position = c(0.17, 0.65),
      legend.background = element_rect(colour="black"),
      legend.margin=margin(t=0.1, r=0.4, b=0.1, l=0.1, unit="cm"),
      legend.spacing.y = unit(0.2, "cm"),
      legend.title = element_text(face="bold", size=11),
      legend.text = element_text(size=9),
      plot.caption = element_text(size=11, color="gray20", face="italic", hjust=0)) +
    guides(size = guide_legend(override.aes=list(colour="gray60")), 
           colour = guide_legend(override.aes=list(size=2)),
           alpha = FALSE)
}
```


```{r}
pos.plot.fx("Quesnel")

### NOW MAKE MORE PLOTS! 
```



<br>

<br>

**Taseko**

```{r include=F, echo=F}
taseko.fcs <- esc.db %>%
  filter(forecast_group=="Taseko", !is.na(peak_spawn) | !is.na(arrival)) %>%
  mutate(POS_start = if_else(year==1976 & peak_spawn=="Mid Sep", as.Date("15-Sep-1976", format="%d-%b-%Y"),
                        if_else(year==1980 & peak_spawn=="Mid Sep", as.Date("15-Sep-1980", format="%d-%b-%Y"),
                            if_else(year==1998 & peak_spawn=="Early Sep.", as.Date("1-Sep-1998", format="%d-%b-%Y"),
                                if_else(year==2007 & is.na(peak_spawn), as.Date("1-Sep-2007", format="%d-%b-%Y"),
                                    if_else(year==2016 & is.na(peak_spawn), as.Date("1-Aug-2016", format="%d-%b-%Y"),
                      as.Date(POS_start)))))),
         POS_end = if_else(year==1976 & peak_spawn=="Mid Sep", as.Date("22-Sep-1976", format="%d-%b-%Y"),
                        if_else(year==1980 & peak_spawn=="Mid Sep", as.Date("22-Sep-1980", format="%d-%b-%Y"),
                            if_else(year==1998 & peak_spawn=="Early Sep.", as.Date("8-Sep-1998", format="%d-%b-%Y"),
                                if_else(year==2007 & is.na(peak_spawn), as.Date("2-Sep-2007", format="%d-%b-%Y"),
                                    if_else(year==2016 & is.na(peak_spawn), as.Date("2-Aug-2016", format="%d-%b-%Y"), 
                    as.Date(POS_start)))))),
         start_yday = ifelse(is.na(start_yday), lubridate::yday(POS_start), start_yday),
         end_yday = ifelse(is.na(end_yday), lubridate::yday(POS_end), end_yday),
         data_type = ifelse(is.na(peak_spawn), "arrival", NA)) %>%
  print()
```

```{r, echo=F, message=F, warning=F}
ggplot(taseko.fcs, 
       aes(x=as.Date(start_yday, origin = as.Date("1970-01-01")), xend=as.Date(end_yday, origin = as.Date("1970-01-01")), 
           y=reorder(year, desc(year)), yend=reorder(year, desc(year)), colour=est_type, size=total)) +
  geom_segment(stat="identity") +
  geom_text(aes(label=data_type), size=4, nudge_x=3.3, nudge_y=0.1, angle=0, check_overlap=T, colour="red") +
  scale_size_continuous(breaks=seq(65,31667,by=15000), range=c(1.5,6)) +
  scale_colour_manual(breaks=c("Type-2: True Abundance, medium resolution", 
                               "Type-3: Relative Abundance, high resolution",
                               "Type-4: Relative Abundance, medium resolution"), 
                      values=c("green", "orange", "red"),
                      labels=c("T2: True abund, med res", "T3: Rel. abund, high res", "T4: Rel. abund, med res")) +
  scale_x_date(date_labels = "%b %d", date_breaks="5 day") +
  labs(x="", y="", colour="Data quality", size="Escapement") +
  theme_bw() +
  theme(text = element_text(colour="black", size=11),
    panel.grid.major.x = element_line(colour="gray80"),
    panel.grid.minor.x = element_blank(),
    panel.grid.major.y = element_line(colour="gray80"),
    panel.spacing = unit(0, "lines"),
    axis.title.y = element_text(face="bold"),
    axis.text = element_text(colour="black", size=11),
    #axis.text.x = element_text(angle=0, hjust=1),
    legend.position = c(0.17, 0.65),
    legend.background = element_rect(colour="black"),
    legend.margin=margin(t=0.1, r=0.4, b=0.1, l=0.1, unit="cm"),
    legend.spacing.y = unit(0.2, "cm"),
    legend.title = element_text(face="bold", size=11),
    legend.text = element_text(size=9),
    plot.caption = element_text(size=11, color="gray20", face="italic", hjust=0)) +
  guides(size = guide_legend(override.aes=list(colour="gray60")), colour = guide_legend(override.aes=list(size=2)))
```


















